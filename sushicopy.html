<div class="wrapper"></div>

<script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { MapControls } from "three/addons/controls/MapControls.js";
    import { FBXLoader } from "three/examples/jsm/loaders/FBXLoader.js";
    /**
     * Provides requestAnimationFrame in a cross browser way.
     * @author paulirish / http://paulirish.com/
     */

    var container;

    var camera, scene, renderer;

    var cube;

    var targetRotationX = 0.5;
    var targetRotationOnMouseDownX = 0;

    var mouseX = 0;
    var mouseXOnMouseDown = 0;

    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;

    var slowingFactor = 0.04;
    let autoRotate = true;

    init();
    animate();

    function init() {
        container = document.createElement("div");
        document.body.appendChild(container);

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.y = 0;
        camera.position.z = 50;
        scene.add(camera);

        var materials = [];

        for (var i = 0; i < 6; i++) {
            materials.push(new THREE.MeshBasicMaterial({ color: Math.random() * 0xffffff }));
        }

        cube = new THREE.Mesh(new THREE.BoxGeometry(20, 20, 20), materials);
        scene.add(cube);

        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);

        container.appendChild(renderer.domElement);

        window.addEventListener("mousedown", onDocumentMouseDown);
    }

    let timer;
    function onDocumentMouseDown(event) {
        event.preventDefault();

        autoRotate = false;
        if (timer) {
            clearTimeout(timer);
        }
        timer = setTimeout(() => {
            autoRotate = true;
        }, 3000);

        document.addEventListener("mousemove", onDocumentMouseMove);
        document.addEventListener("mouseup", onDocumentMouseUp);
        document.addEventListener("mouseout", onDocumentMouseUp);

        mouseXOnMouseDown = event.clientX - windowHalfX;
    }

    function onDocumentMouseMove(event) {
        mouseX = event.clientX - windowHalfX;
        targetRotationX = (mouseX - mouseXOnMouseDown) * 0.00025;
    }

    function onDocumentMouseUp(event) {
        document.removeEventListener("mousemove", onDocumentMouseMove);
        document.removeEventListener("mouseup", onDocumentMouseUp);
        document.removeEventListener("mouseout", onDocumentMouseUp);
    }

    function animate() {
        requestAnimationFrame(animate);
        render();
    }

    function render() {
        if (autoRotate) targetRotationX = 0.0025;
        rotateAroundWorldAxis(cube, new THREE.Vector3(0, 1, 0), targetRotationX);
        targetRotationX = targetRotationX * (1 - slowingFactor);
        renderer.render(scene, camera);
    }

    function rotateAroundWorldAxis(object, axis, radians) {
        var rotationMatrix = new THREE.Matrix4();

        rotationMatrix.makeRotationAxis(axis.normalize(), radians);
        rotationMatrix.multiply(object.matrix); // pre-multiply
        object.matrix = rotationMatrix;
        object.rotation.setFromRotationMatrix(object.matrix);
    }
</script>
