<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <title></title>
        <style>
            body {
                overflow: hidden;
                margin: 0;
            }

            .userInfo {
                position: absolute;
                width: 90vw;
                height: 6vh;
                background: #fff;
                border-radius: 10px;
                top: 25vw;
                left: 5vw;
                transition: all 0.5s ease-in-out;
            }

            .detail {
                position: fixed;
                width: 100vw;
                height: 100vh;
                background-color: rgba(255, 255, 255, 0.5);
                top: 120vh;
                left: 0;
                transition: all 0.5s ease-in-out;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }

            .detail.more {
                background-color: rgba(255, 255, 255, 0.5);
                transition: all 0.5s ease-in-out;
            }

            .detail .hold {
                background-color: #fd6e24;
                color: #fff;
                font-size: 12px;
                font-weight: 400;
                line-height: 12px;
                letter-spacing: -0.02em;
                text-align: left;
                border-radius: 4px;
                padding: 6px 8px;
            }

            .detail .artist span {
                font-size: 16px;
                font-weight: 700;
                line-height: 16px;
                letter-spacing: -0.02em;
                text-align: left;
            }

            .detail .dropNo {
                font-size: 14px;
                font-weight: 400;
                line-height: 14px;
                letter-spacing: -0.02em;
                text-align: left;
            }

            .detail .artName {
                font-size: 20px;
                font-weight: 700;
                line-height: 26px;
                letter-spacing: -0.03em;
                text-align: left;
            }

            .detail .owner {
                font-size: 20px;
                font-weight: 700;
                line-height: 26px;
                letter-spacing: -0.03em;
                text-align: left;
            }

            .detail .more {
                font-size: 14px;
                font-weight: 400;
                line-height: 14px;
                letter-spacing: -0.02em;
                text-align: left;
                color: #fd6e24;
            }

            .detail .bottom {
                /* position: fixed;
                bottom: 0;
                border: 1px solid red;
                width: 100%;
                margin-bottom: 34px; */
            }
        </style>
    </head>
    <body>
        <div class="userInfo">
            Collectorman
            <button>button test</button>
        </div>
        <canvas id="drop"></canvas>
        <div class="detail">
            <div class="hold"><button>보유중</button></div>
            <div class="wrapper">
                <div class="info">
                    <div class="artist">
                        <img src="" />
                        <span>abcdefghijklmnopqrst</span>
                    </div>
                    <h6 class="dropNo">Drop #1</h6>
                    <h4 class="artName">A SWEET DAY</h4>
                    <div class="owner">Owner 1024</div>
                    <div class="more" onclick="test()">MORE INFO</div>
                </div>
                <div class="bottom">
                    <button>OPEN</button>
                </div>
            </div>
        </div>
        <script>
            function test(e) {
                alert("ddd");
                document.querySelector(".more").innerHTML =
                    "작품설명  작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명";
            }
        </script>
        <script type="module">
            import * as THREE from "three";
            import { MapControls } from "three/addons/controls/MapControls.js";
            import { FBXLoader } from "three/examples/jsm/loaders/FBXLoader.js";

            import gsap from "gsap";

            const scene = new THREE.Scene();
            let camera, renderer, controls;

            const space = new THREE.Group();
            const loader = new FBXLoader();
            const mixers = [];
            let mixer = new THREE.AnimationMixer();
            let clock = new THREE.Clock();

            let profileArea;
            let detailArea;

            const dropData = [
                {
                    id: 0,
                    url: "data/DoCoin_LinearSpin.fbx",
                    bumpMap: "data/DSP_DoCoin.png",
                    colorMap: "data/D_DoCoin.png",
                    specularMap: "data/SPC_DoCoin.png",
                    my: false,
                    detail: {
                        artistImg: "data/image_17.png",
                        artistName: "abcdefghijklmnopqrst",
                        artName: "A SWEET DAY",
                        owner: 1024,
                        artDesc:
                            "작품설명  작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 작품설명 ",
                    },
                },
                {
                    id: 1,
                    url: "data/KominJeong_Popup.fbx",
                    bumpMap: "data/DSP_outside_KominJeong.png",
                    colorMap: "data/D_outside_KominJeong.png",
                    // url: "",
                    my: true,
                },
                {
                    id: 2,
                    // url: "data/DoCoin_Static.fbx",
                    url: "",
                    my: false,
                },
                {
                    id: 3,
                    url: "data/275C_LinearSpin.fbx",
                    colorMap: "data/D_275C.png", // url: "",
                    my: false,
                },
                {
                    id: 4,
                    // url: "data/KominJeong_Popup.fbx",
                    url: "",
                    my: false,
                },
                {
                    id: 5,
                    // url: "data/KominJeong_Static.fbx",
                    url: "",
                    my: false,
                },
                {
                    id: 6,
                    url: "data/275C_LinearSpin.fbx",
                    colorMap: "data/D_275C.png",
                    my: false,
                },
                {
                    id: 7,
                    url: "",
                    my: false,
                },
                {
                    id: 8,
                    url: "",
                    my: false,
                },
            ];

            init();
            setSpace();
            setDrop();
            render();

            // scene.add(new THREE.GridHelper(20, 20, 0xff80ed, 0x444444));

            function init() {
                const canvas = document.getElementById("drop");
                profileArea = document.querySelector(".userInfo");
                detailArea = document.querySelector(".detail");

                // render hive
                renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
                // renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                // document.querySelector(".wrapper").appendChild(renderer.domElement);

                const lastDrop = dropData.findLast((e) => e.my === true);

                // camera
                camera = new THREE.PerspectiveCamera(100, window.innerWidth / window.innerHeight, 0.01, 1000);
                camera.position.set(lastDrop.id * 2.5, 4, 10);
                // camera.position.set(0, 5, 0);

                // light
                let light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(10, 7, 0);
                // light.castShadow = true;
                // scene.add(light);
                // scene.add(new THREE.DirectionalLightHelper(light, 1, "red"));
                scene.add(new THREE.AmbientLight(0xffffff, 0.4));

                const pointLight = new THREE.PointLight(0xffffff, 1, 100);
                pointLight.position.set(7, 10, 0);
                // pointLight.castShadow = true;
                // pointLight.shadow.mapSize.width = 2048;
                // pointLight.shadow.mapSize.height = 2048;
                scene.add(pointLight);
                const sphereSize = 1;
                const pointLightHelper = new THREE.PointLightHelper(pointLight, sphereSize);
                scene.add(pointLightHelper);

                // controls
                controls = new MapControls(camera, renderer.domElement);
                controls.target = new THREE.Vector3(lastDrop.id * 2.5, 3, 0);
                controls.touches = { ONE: THREE.TOUCH.PAN };
                controls.minDistance = 4;
                controls.maxDistance = 20;
                controls.enableRotate = false;
                controls.update();

                // Limits;
                const maxX = (dropData.length - 1) * 2.5;
                const minX = 0;
                const maxZ = 2;
                const minZ = 0;

                // State
                let positionX;
                let positionZ;
                let phi;
                let theta;

                controls.addEventListener("change", (e) => {
                    const x = controls.target.x;
                    const z = controls.target.z;
                    let shallWeUpdateAngle = false;

                    if (x < minX || x > maxX) {
                        controls.target.setX(x < minX ? minX : maxX);
                        camera.position.setX(positionX);
                        shallWeUpdateAngle = true;
                    }
                    if (z < minZ || z > maxZ) {
                        controls.target.setZ(z < minZ ? minZ : maxZ);
                        camera.position.setZ(positionZ);
                        shallWeUpdateAngle = true;
                    }

                    if (shallWeUpdateAngle) {
                        const distance = camera.position.distanceTo(controls.target);
                        camera.position.set(distance * Math.sin(phi) * Math.sin(theta) + controls.target.x, distance * Math.cos(phi) + controls.target.y, distance * Math.sin(phi) * Math.cos(theta) + controls.target.z);
                    }

                    // Updating state
                    positionX = camera.position.x;
                    positionZ = camera.position.z;
                    phi = controls.getPolarAngle();
                    theta = controls.getAzimuthalAngle();
                });

                window.addEventListener("click", clickEvent);

                // 첫 로딩시, 화면 줌인
                setTimeout(() => {
                    gsap.to(camera, {
                        fov: 50,
                        duration: 1,
                        ease: "power4.inOut",
                        onUpdate: function () {
                            camera.updateProjectionMatrix();
                        },
                    });
                }, 300);
            }

            let beforePosition = -1;
            let column;
            let clickDrop;
            function clickEvent(event) {
                let parent;
                const raycaster = new THREE.Raycaster();
                const pointer = new THREE.Vector2();

                pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
                pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(pointer, camera);

                const intersects = raycaster.intersectObjects(scene.children);
                // console.log(intersects);
                // console.log(intersects);
                if (intersects.length > 0) {
                    parent = intersects[0].object.parent;
                    // if (intersects[0].object.name === "button") alert("button");
                    // console.log(intersects[0].object.position);

                    // console.log(column);
                    if (parent.name.includes("drop")) {
                        clickDrop = intersects[0].object.material;
                        gsap.to(clickDrop, {
                            duration: 1,
                            opacity: 1,
                            // map: new THREE.TextureLoader().load("data/D_275C.png"),
                            ease: "power3.inOut",
                        });
                        gsap.to(clickDrop, {
                            duration: 0.5,
                            wireframe: false,
                            ease: "power3.inOut",
                        });

                        detailArea.style.top = 0;
                        profileArea.style.opacity = 0;
                        column = scene.getObjectByName("column" + parent.name.replace(/[^0-9]/g, ""));
                        gsap.to(column.material, {
                            duration: 1,
                            opacity: 0,
                            ease: "power3.inOut",
                        });

                        gsap.to(controls.target, {
                            duration: 1,
                            x: parent.position.x,
                            y: 3,
                            ease: "power3.inOut",
                            onUpdate: function () {
                                controls.update();
                            },
                        });
                        gsap.to(camera.position, {
                            // delay: 1,
                            duration: 1,
                            ease: "power3.inOut",
                            x: parent.position.x,
                            y: 3.3,
                            z: 3,
                            onUpdate: function () {
                                controls.update();
                            },
                        });

                        beforePosition = parent.position.x;
                        controls.enabled = false;
                    }

                    // if (beforePosition > -1 && intersects[0].object.name === "") {
                    //     gsap.to(clickDrop, {
                    //         duration: 1,
                    //         opacity: 0.3,
                    //         ease: "power3.inOut",
                    //     });

                    //     gsap.to(clickDrop, {
                    //         duration: 0.5,
                    //         wireframe: true,
                    //         ease: "power3.inOut",
                    //     });

                    //     detailArea.style.top = "120vh";
                    //     profileArea.style.opacity = 1;
                    //     gsap.to(column.material, {
                    //         duration: 1,
                    //         opacity: 1,
                    //         ease: "power3.inOut",
                    //     });

                    //     gsap.to(controls.target, {
                    //         duration: 1,
                    //         x: beforePosition,
                    //         // y: 3,
                    //         // z: 0,
                    //         // ease: "power4.in",
                    //         ease: "power3.inOut",
                    //         onUpdate: function () {
                    //             controls.update();
                    //         },
                    //     });
                    //     gsap.to(camera.position, {
                    //         // delay: 1,
                    //         duration: 1,
                    //         ease: "power3.inOut",
                    //         x: beforePosition,
                    //         y: 4,
                    //         z: 10,
                    //         onUpdate: function () {
                    //             controls.update();
                    //         },
                    //     });

                    //     beforePosition = -1;
                    //     controls.enabled = true;
                    // }
                }
            }

            function setSpace() {
                // 바닥
                const geo = new THREE.PlaneGeometry(40, 30);
                const mat = new THREE.MeshStandardMaterial({
                    color: "#F5F5F5",
                    side: THREE.DoubleSide,
                });
                // shadow blur
                //https://github.com/mrdoob/three.js/blob/master/examples/webgl_shadow_contact.html
                const ground = new THREE.Mesh(geo, mat);
                ground.position.z = 5;
                ground.rotation.x = Math.PI * 0.5;
                // ground.receiveShadow = true;

                // 벽
                const wall = new THREE.Mesh(geo, mat);
                wall.position.z = -5;

                // 천장
                const roof = new THREE.Mesh(geo, mat);
                roof.rotation.x = Math.PI * 0.5;
                roof.position.y = 8;

                space.add(ground);
                space.add(wall);
                space.add(roof);
                space.position.x = 15;
                scene.add(space);
            }

            function setDrop() {
                const geo = new THREE.BoxGeometry(1.5, 2, 1.5);
                const mat = new THREE.MeshStandardMaterial({
                    color: "#ffffff",
                    transparent: true,
                });

                for (let i = 0; i < dropData.length; i++) {
                    const group = new THREE.Group();
                    // column
                    const column = new THREE.Mesh(geo, mat);
                    column.receiveShadow = true;
                    column.position.x = i * 2.5;
                    column.position.y = 1;
                    column.name = "column" + i;
                    scene.add(column);

                    if (dropData[i].url) {
                        loader.load(dropData[i].url, (obj) => {
                            // const drop = new THREE.Group();
                            obj.scale.multiplyScalar(0.05);
                            obj.position.x = i * 2.5;
                            obj.position.y = 2.5;
                            obj.traverse(function (child) {
                                if (child.isMesh) {
                                    let color1, colorMap, bumpMap, specularMap, wireframe, opacity;
                                    colorMap = new THREE.TextureLoader().load(dropData[i].colorMap);
                                    bumpMap = new THREE.TextureLoader().load(dropData[i].bumpMap);
                                    specularMap = new THREE.TextureLoader().load(dropData[i].specularMap);
                                    if (dropData[i].my) {
                                        opacity = 1;
                                        wireframe = false;
                                    } else {
                                        opacity = 0.3;
                                        wireframe = true;
                                    }
                                    const minigunMaterial = new THREE.MeshPhongMaterial({
                                        map: colorMap,
                                        bumpMap,
                                        specularMap,
                                        transparent: true,
                                        // opacity: opacity,
                                        wireframe,
                                    });

                                    child.material = minigunMaterial;
                                    child.castShadow = true;
                                    child.receiveShadow = true;
                                }
                            });
                            obj.name = "drop" + i;

                            mixer = new THREE.AnimationMixer(obj);
                            const action = mixer.clipAction(obj.animations[0]).play();
                            mixers.push(mixer);

                            scene.add(obj);
                        });
                    }
                }
            }

            function animate() {
                const delta = clock.getDelta();
                for (const mixer of mixers) mixer.update(delta);
            }

            function render() {
                animate();
                requestAnimationFrame(render);
                renderer.render(scene, camera);
            }
        </script>
    </body>
</html>
